generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        Int     @id @default(autoincrement())
  name      String
  email     String  @unique
  phone_number String? @unique
  password  String
  avatar_url        String? 
  avatar_public_id  String?
  role_id   Int     @default(2)
  role      Role?   @relation(fields: [role_id], references: [id])
  is_active          Boolean   @default(true)
  is_email_verified  Boolean   @default(false)
  email_verification_token String?
  email_verification_expiry DateTime?
  email_verified_at         DateTime?
  forgot_password_token   String?
  forgot_password_expires DateTime?
  provider       String?   
  provider_id    String?   
  refresh_token        String?
  refresh_token_expires DateTime?
  last_login_at         DateTime?
  failed_login_attempts Int       @default(0)
  locked_until          DateTime?
  cart       Cart[]
  wishlist   Wishlist[]
  review     Review[]
  order      Order[]
  coupons    Coupon[] @relation("UserCoupons")
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}

model Role {
  id    Int    @id @default(autoincrement())
  name  String @unique

  users User[]
}

model Product {
  id          Int      @id @default(autoincrement())
  name        String
  slug        String
  description String?
  brand       String?

  category_id Int
  category    Category? @relation(fields: [category_id], references: [id])
  variants    ProductVariant[]
  pincode     ProductPincode[]
  coupons     Coupon[] @relation("ProductCoupons")
  review      Review[]
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
}

model ProductVariant {
  id        Int    @id @default(autoincrement())
  product_id Int
  product    Product @relation(fields: [product_id], references: [id])
  color      String?
  size       String?
  original_price      Int
  discounted_price    Int
  stock      Int     @default(0)
  sku        String  @unique
  images     ProductImage[]
  cart_item  CartItem[]
  wishlist   Wishlist[]
  order_item OrderItem[]
  is_active  Boolean @default(true)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([product_id, color, size])
}

model ProductImage {
  id          Int    @id @default(autoincrement())
  variant_id  Int
  variant     ProductVariant @relation(fields: [variant_id], references: [id])
  image_url       String
  image_public_id String
  is_primary  Boolean @default(false)
  created_at DateTime        @default(now())
  updated_at DateTime        @updatedAt
}

model ProductPincode {
  id         Int     @id @default(autoincrement())
  product_id Int
  product    Product @relation(fields: [product_id], references: [id])
  pincode    String  
  created_at DateTime @default(now())
  @@unique([product_id, pincode]) 
}

model Category {
  id        Int       @id @default(autoincrement())
  name      String    @unique
  slug      String    @unique   
  description String?
  image_url   String? 
  image_public_id  String?
  products  Product[] 
  is_active Boolean   @default(true)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}

model Cart {
  id        Int     @id @default(autoincrement())
  user_id   Int
  user      User    @relation(fields: [user_id], references: [id])
  items     CartItem[]
  is_active Boolean @default(true)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}

model CartItem {
  id               Int             @id @default(autoincrement())
  cart_id          Int
  cart             Cart            @relation(fields: [cart_id], references: [id])
  product_variant_id Int
  product_variant   ProductVariant @relation(fields: [product_variant_id], references: [id])
  quantity         Int             @default(1)
  price            Int
  created_at       DateTime        @default(now())
  updated_at       DateTime        @updatedAt
  @@unique([cart_id, product_variant_id]) 
}

enum DiscountType {
  PERCENTAGE
  FIXED
}

model Coupon {
  id             Int          @id @default(autoincrement())
  code           String       @unique
  description    String?
  discount_type  DiscountType
  discount_value Int
  start_date     DateTime
  end_date       DateTime
  max_uses       Int?
  min_purchase   Int?
  is_active      Boolean      @default(true)
  is_global      Boolean      @default(false)
  products       Product[]    @relation("ProductCoupons")
  orders         Order[]      
  users          User[]       @relation("UserCoupons")
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}

model Wishlist {
  id                Int             @id @default(autoincrement())
  user_id           Int
  user              User            @relation(fields: [user_id], references: [id])
  product_variant_id Int
  product_variant   ProductVariant  @relation(fields: [product_variant_id], references: [id])
  created_at        DateTime        @default(now())

  @@unique([user_id, product_variant_id])
}

model Review {
  id         Int       @id @default(autoincrement())
  user_id    Int
  user       User      @relation(fields: [user_id], references: [id])
  product_id Int
  product    Product   @relation(fields: [product_id], references: [id])

  rating     Int       
  comment    String?
  
  created_at DateTime  @default(now())
  updated_at DateTime  @updatedAt

  @@unique([user_id, product_id])
}

enum OrderStatus {
  PENDING
  PAID
  SHIPPED
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}


model Order {
  id           Int         @id @default(autoincrement())
  user_id      Int
  user         User        @relation(fields: [user_id], references: [id])
  order_number String      @unique 
  total_amount Int
  discount_amount Int      @default(0)
  final_amount Int 
  coupon_id    Int?        
  coupon       Coupon?     @relation(fields: [coupon_id], references: [id])
  status       OrderStatus      @default(PENDING) 
  payment_status PaymentStatus  @default(PENDING) 
  payment_method String?   
  shipping_address String
  items        OrderItem[]
  created_at   DateTime    @default(now())
  updated_at   DateTime    @updatedAt
}

model OrderItem {
  id                 Int             @id @default(autoincrement())
  order_id           Int
  order              Order           @relation(fields: [order_id], references: [id])
  product_variant_id Int
  product_variant    ProductVariant  @relation(fields: [product_variant_id], references: [id])
  quantity           Int             @default(1)
  price              Int
  created_at         DateTime        @default(now())
  updated_at         DateTime        @updatedAt
  @@unique([order_id, product_variant_id])
}